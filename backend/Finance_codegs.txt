/**
 * JSON / JSONP válaszgenerálás (Booklist minta alapján).
 */
function createJsonOrJsonpResponse_(obj, callback) {
  const json = JSON.stringify(obj);
  if (callback) {
    return ContentService
      .createTextOutput(callback + "(" + json + ");")
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  return ContentService
    .createTextOutput(json)
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * GET alapú API (JSONP támogatással).
 * Ezt fogja hívni a file://-ről futó HTML.
 */
function doGet(e) {
  const p = e && e.parameter ? e.parameter : {};
  const action = p.action;
  const callback = p.callback;
  let result;

  try {
    if (action === "addTransaction") {
      const tx = {
        month:           p.month           || "",
        date:            p.date            || "",
        amount:          p.amount          || "",
        title:           p.title           || "",
        category:        p.category        || "",
        payment_type:    p.payment_type    || "",
        transaction_type:p.transaction_type|| "",
        is_shared:       p.is_shared       || "",
        statement_item:  p.statement_item  || ""
      };

      result = addTransaction_(tx);
    } else if (action === "getTransactions") {
      result = getTransactions_();
    } else if (action === "getValueSets") {
      result = getValueSets_();
    } else if (action === "updateTransaction") {
        const tx = {
            id:              p.id              || "",
            month:           p.month           || "",
            date:            p.date            || "",
            amount:          p.amount          || "",
            title:           p.title           || "",
            category:        p.category        || "",
            payment_type:    p.payment_type    || "",
            transaction_type:p.transaction_type|| "",
            is_shared:       p.is_shared       || "",
            statement_item:  p.statement_item  || ""
        };

        result = updateTransaction_(tx);
    }

     else {
      result = { success: false, error: "Ismeretlen action: " + action };
    }

  } catch (err) {
    result = { success: false, error: err.message || String(err) };
  }

  return createJsonOrJsonpResponse_(result, callback);
}

/**
 * Segédfüggvény: beszúr egy sort a Transactions sheetbe.
 */
function addTransaction_(tx) {
  const sheet = SpreadsheetApp.getActive().getSheetByName("Transactions");
  if (!sheet) {
    throw new Error('Nem található a "Transactions" nevű munkalap.');
  }

  const id = Utilities.getUuid();
  const created_at = new Date();
  const created_by = Session.getActiveUser().getEmail() || "unknown";

  const row = [
    id,
    tx.month,
    tx.date,
    tx.amount,
    tx.title,
    tx.category,
    tx.payment_type,
    tx.transaction_type,
    tx.is_shared,
    tx.statement_item,
    created_by,
    created_at
  ];

  sheet.appendRow(row);
  addValueIfMissing_("title_values", tx.title);
  addValueIfMissing_("category_values", tx.category);
  addValueIfMissing_("payment_type_values", tx.payment_type);
  addValueIfMissing_("transaction_type_values", tx.transaction_type);
  return { success: true, id: id };
}
/**
 * Segédfüggvény: módosít egy meglévő sort a Transactions sheetben.
 */
function updateTransaction_(tx) {
  const sheet = SpreadsheetApp.getActive().getSheetByName("Transactions");
  if (!sheet) {
    throw new Error('Nem található a "Transactions" nevű munkalap.');
  }

  const data = sheet.getDataRange().getValues();
  const header = data[0];

  // ID az első oszlopban van → index 0
  const idCol = 0;

  // Megkeressük, melyik sorban van az ID
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][idCol]).trim() === String(tx.id).trim()) {
      rowIndex = i + 1; // Google Sheets 1-indexelt
      break;
    }
  }

  if (rowIndex === -1) {
    return { success: false, error: "Nincs ilyen ID: " + tx.id };
  }

  // Felülírjuk a sort (ID oszlopot nem módosítjuk)
  const updatedRow = [
    tx.id,
    tx.month,
    tx.date,
    tx.amount,
    tx.title,
    tx.category,
    tx.payment_type,
    tx.transaction_type,
    tx.is_shared,
    tx.statement_item,
    data[rowIndex - 1][10], // created_by (változatlan)
    data[rowIndex - 1][11]  // created_at (változatlan)
  ];

  sheet.getRange(rowIndex, 1, 1, updatedRow.length).setValues([updatedRow]);

  return { success: true, id: tx.id };
}

function getTransactions_() {
  const sheet = SpreadsheetApp.getActive().getSheetByName("Transactions");
  const data = sheet.getDataRange().getValues();

  const header = data[0];
  const rows = data.slice(1).map(row => {
    const obj = {};
    header.forEach((h, i) => {
      obj[h] = row[i];
    });
    return obj;
  });

  return { success: true, data: rows };
}
function getValueSets_() {
  const sheet = SpreadsheetApp.getActive().getSheetByName("Value_Sets");

  const values = sheet.getDataRange().getValues();
  const header = values[0];

  // Oszlopindexek
  const colTitle = header.indexOf("title_values");
  const colCategory = header.indexOf("category_values");
  const colPayment = header.indexOf("payment_type_values");
  const colType = header.indexOf("transaction_type_values");

  const titles = [];
  const categories = [];
  const payments = [];
  const types = [];

  for (let i = 1; i < values.length; i++) {
    if (values[i][colTitle]) titles.push(values[i][colTitle]);
    if (values[i][colCategory]) categories.push(values[i][colCategory]);
    if (values[i][colPayment]) payments.push(values[i][colPayment]);
    if (values[i][colType]) types.push(values[i][colType]);
  }

  return {
    success: true,
    sets: {
      titles,
      categories,
      payments,
      types
    }
  };
}
function addValueIfMissing_(columnName, value) {
  if (!value) return;

  const sheet = SpreadsheetApp.getActive().getSheetByName("Value_Sets");
  const data = sheet.getDataRange().getValues();
  const header = data[0];

  const colIndex = header.indexOf(columnName);
  if (colIndex === -1) return;

  // Már létezik?
  for (let i = 1; i < data.length; i++) {
    if (
      String(data[i][colIndex]).trim().toLowerCase() ===
      String(value).trim().toLowerCase()
    ) {
      return;
    }
  }

  // Következő üres sor keresése ebben az oszlopban
  let insertRow = 1;
  for (let i = 1; i < data.length; i++) {
    if (data[i][colIndex] === "" || data[i][colIndex] === null) {
      insertRow = i + 1; // Google Sheets 1-indexelt
      break;
    }
    insertRow = i + 2; // ha nincs több üres cella
  }

  // Beszúrjuk az értéket az adott oszlop megfelelő cellájába
  sheet.getRange(insertRow, colIndex + 1).setValue(value);
}

